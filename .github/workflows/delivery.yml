---
name: ci

on: [push, pull_request]

jobs:
  delivery:

    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@master
    - name: Run Chef Delivery
      uses: actionshub/chef-delivery@master
      env:
        CHEF_LICENSE: accept-no-persist

  testing:
    needs: [delivery]
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@master
      - name: Install Chef
        uses: actionshub/chef-install@master
      - name: PolicyFile test
        run: chef install policyfiles/Policyfile.rb
        env:
          CHEF_LICENSE: accept-no-persist
      - name: Install Chef Habitat
        uses: collinmcneese/chef-habitat-install@master
      - name: Build Habitat package
        run: export pkg_origin=$(grep '^pkg_origin' habitat/plan.sh | awk -F'=' '{print $2}') ; hab origin key generate ${pkg_origin} ; hab studio -k ${pkg_origin} build .
        env:
          HAB_LICENSE: accept-no-persist
      - name: Validate Chef Habitat Build
        run: if [ -f results/last_build.env ] ; then echo "success" ; else exit 1 ; fi
      - name: Install Chef Habitat Builder
        run: git clone https://github.com/habitat-sh/on-prem-builder.git ; cp test/scripts/bldr.env on-prem-builder/ ; cd on-prem-builder ; sudo sh install.sh
        env:
          HAB_LICENSE: accept-no-persist
      - name: Setup Chef Habitat Builder
        run: sh test/scripts/bldr_setup.sh
        env:
          HAB_LICENSE: accept-no-persist
      - name: Test kitchen
        run: kitchen converge -c
        env:
          HAB_LICENSE: accept-no-persist
          CHEF_LICENSE: accept-no-persist
      # Reference repo, no direct tests to run
      # - name: kitchen
      #   run: kitchen converge
      #   env:
      #     CHEF_LICENSE: accept-no-persist
      #     KITCHEN_LOCAL_YAML: kitchen.shell.yml

